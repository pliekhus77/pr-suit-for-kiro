name: Deploy to Marketplace

# Trigger on GitHub release published
on:
  release:
    types: [published]

# Ensure only one deployment runs at a time
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

# Optional: Configure environment for production deployment
# Uncomment to enable manual approval requirement
# environment:
#   name: production
#   url: https://marketplace.visualstudio.com/items?itemName=pragmatic-rhino.pragmatic-rhino-suit

jobs:
  deploy:
    name: Deploy to VS Code Marketplace
    runs-on: ubuntu-latest
    
    # Set timeout to prevent hanging deployments
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Extract version from release tag
        id: extract-version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "📌 Release version: $VERSION"
          echo "📌 Release tag: $TAG_NAME"
      
      - name: Find package workflow run
        id: find-workflow
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          TAG_NAME="${{ github.event.release.tag_name }}"
          
          echo "🔍 Searching for package workflow run for tag: $TAG_NAME"
          
          # Use GitHub API to find the workflow run that created the artifact
          WORKFLOW_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/package.yml/runs?event=push&status=success&per_page=10")
          
          # Find the run that matches our tag
          RUN_ID=$(echo "$WORKFLOW_RUNS" | jq -r ".workflow_runs[] | select(.head_branch == \"$TAG_NAME\") | .id" | head -n 1)
          
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "❌ Could not find successful package workflow run for tag $TAG_NAME"
            echo "workflow-found=false" >> $GITHUB_OUTPUT
            
            echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** Package workflow run not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Could not find a successful package workflow run for tag \`$TAG_NAME\`." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Troubleshooting Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Verify the package workflow ran successfully for tag \`$TAG_NAME\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Check [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions/workflows/package.yml)" >> $GITHUB_STEP_SUMMARY
            echo "3. Ensure the tag was pushed before creating the release" >> $GITHUB_STEP_SUMMARY
            echo "4. Wait a few minutes if the package workflow is still running" >> $GITHUB_STEP_SUMMARY
            
            exit 1
          fi
          
          echo "workflow-found=true" >> $GITHUB_OUTPUT
          echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "✅ Found package workflow run: $RUN_ID"
      
      - name: Download VSIX artifact from package workflow
        id: download
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          RUN_ID="${{ steps.find-workflow.outputs.run-id }}"
          ARTIFACT_NAME="vsix-package-${VERSION}"
          
          echo "📥 Downloading artifact: $ARTIFACT_NAME"
          echo "📦 From workflow run: $RUN_ID"
          
          # List artifacts for the workflow run
          ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts")
          
          # Find the artifact ID
          ARTIFACT_ID=$(echo "$ARTIFACTS" | jq -r ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id" | head -n 1)
          
          if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" == "null" ]; then
            echo "❌ Artifact not found: $ARTIFACT_NAME"
            echo "artifact-found=false" >> $GITHUB_OUTPUT
            
            echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** VSIX artifact not found in package workflow" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The artifact \`$ARTIFACT_NAME\` was not found in workflow run $RUN_ID." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Available Artifacts:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$ARTIFACTS" | jq -r '.artifacts[] | "- \(.name) (ID: \(.id))"' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            exit 1
          fi
          
          echo "artifact-found=true" >> $GITHUB_OUTPUT
          echo "artifact-id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
          echo "✅ Found artifact ID: $ARTIFACT_ID"
          
          # Download the artifact
          mkdir -p ./artifacts
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
            -o ./artifacts/artifact.zip
          
          # Extract the artifact
          cd ./artifacts
          unzip -q artifact.zip
          rm artifact.zip
          cd ..
          
          echo "✅ Artifact downloaded and extracted"
      
      - name: Verify artifact download
        id: verify-artifact
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          VSIX_FILE="./artifacts/pragmatic-rhino-suit-${VERSION}.vsix"
          
          if [ ! -f "$VSIX_FILE" ]; then
            echo "❌ VSIX file not found after extraction: $VSIX_FILE"
            echo "artifact-found=false" >> $GITHUB_OUTPUT
            
            echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** VSIX file not found after artifact extraction" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The artifact was downloaded but the expected VSIX file was not found." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Expected File:" >> $GITHUB_STEP_SUMMARY
            echo "\`$VSIX_FILE\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Actual Contents:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -la ./artifacts/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s "$VSIX_FILE" 2>/dev/null || stat -f%z "$VSIX_FILE")
          FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc)
          
          echo "artifact-found=true" >> $GITHUB_OUTPUT
          echo "vsix-file=$VSIX_FILE" >> $GITHUB_OUTPUT
          echo "file-size=$FILE_SIZE" >> $GITHUB_OUTPUT
          echo "✅ VSIX artifact found: $VSIX_FILE ($FILE_SIZE_MB MB)"
      
      - name: Validate file integrity
        run: |
          VSIX_FILE="${{ steps.verify-artifact.outputs.vsix-file }}"
          
          echo "🔍 Validating VSIX file integrity..."
          
          # Check if file is a valid ZIP archive (VSIX is a ZIP file)
          if ! unzip -t "$VSIX_FILE" > /dev/null 2>&1; then
            echo "❌ VSIX file is corrupted or not a valid ZIP archive"
            exit 1
          fi
          
          echo "✅ VSIX file integrity check passed"
      
      - name: Authenticate with VS Code Marketplace
        id: auth
        run: |
          if [ -z "${{ secrets.VSCE_PAT }}" ]; then
            echo "❌ VSCE_PAT secret is not configured"
            echo "auth-success=false" >> $GITHUB_OUTPUT
            
            echo "## ❌ Authentication Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** VSCE_PAT secret is not configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Setup Instructions:" >> $GITHUB_STEP_SUMMARY
            echo "1. Create a Personal Access Token (PAT) in Azure DevOps" >> $GITHUB_STEP_SUMMARY
            echo "2. Grant the token 'Marketplace (Publish)' scope" >> $GITHUB_STEP_SUMMARY
            echo "3. Add the token as a GitHub secret named \`VSCE_PAT\`" >> $GITHUB_STEP_SUMMARY
            echo "4. See [docs/deployment/SECRETS.md](../docs/deployment/SECRETS.md) for detailed instructions" >> $GITHUB_STEP_SUMMARY
            
            exit 1
          fi
          
          echo "auth-success=true" >> $GITHUB_OUTPUT
          echo "✅ VSCE_PAT secret is configured"
        env:
          # Ensure secret is masked in logs
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
      
      - name: Install vsce
        run: |
          echo "📦 Installing vsce (Visual Studio Code Extension Manager)..."
          npm install -g @vscode/vsce
          vsce --version
      
      - name: Publish to VS Code Marketplace
        id: publish
        run: |
          VSIX_FILE="${{ steps.verify-artifact.outputs.vsix-file }}"
          VERSION="${{ steps.extract-version.outputs.version }}"
          
          echo "🚀 Publishing extension to VS Code Marketplace..."
          echo "📦 VSIX File: $VSIX_FILE"
          echo "📌 Version: $VERSION"
          
          # Publish with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          RETRY_DELAY=10
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if vsce publish --packagePath "$VSIX_FILE" --pat "${{ secrets.VSCE_PAT }}"; then
              echo "publish-success=true" >> $GITHUB_OUTPUT
              echo "✅ Extension published successfully!"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Publish attempt $RETRY_COUNT failed. Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))  # Exponential backoff
              else
                echo "publish-success=false" >> $GITHUB_OUTPUT
                echo "❌ Failed to publish after $MAX_RETRIES attempts"
                
                echo "## ❌ Marketplace Publishing Failed" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Reason:** Marketplace rejected the package after $MAX_RETRIES attempts" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### Possible Causes:" >> $GITHUB_STEP_SUMMARY
                echo "- Invalid or expired VSCE_PAT token" >> $GITHUB_STEP_SUMMARY
                echo "- Version already exists on marketplace" >> $GITHUB_STEP_SUMMARY
                echo "- Package validation failed" >> $GITHUB_STEP_SUMMARY
                echo "- Marketplace service unavailable" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
                echo "1. Check the error message above for specific details" >> $GITHUB_STEP_SUMMARY
                echo "2. Verify VSCE_PAT token is valid and has correct permissions" >> $GITHUB_STEP_SUMMARY
                echo "3. Check marketplace status: https://marketplace.visualstudio.com/" >> $GITHUB_STEP_SUMMARY
                echo "4. Consider using the rollback workflow if needed" >> $GITHUB_STEP_SUMMARY
                
                exit 1
              fi
            fi
          done
        env:
          # Ensure PAT is masked in logs
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
      
      - name: Wait for marketplace processing
        run: |
          echo "⏳ Waiting for marketplace to process the extension..."
          echo "This typically takes 1-2 minutes..."
          sleep 60
      
      - name: Verify deployment on marketplace
        id: verify
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          EXTENSION_ID="pragmatic-rhino.pragmatic-rhino-suit"
          
          echo "🔍 Verifying extension is live on marketplace..."
          
          # Run verification script
          if node scripts/verify-deployment.js "$EXTENSION_ID" "$VERSION"; then
            echo "verify-success=true" >> $GITHUB_OUTPUT
            echo "✅ Deployment verification passed!"
          else
            echo "verify-success=false" >> $GITHUB_OUTPUT
            echo "⚠️ Deployment verification failed"
            
            echo "## ⚠️ Deployment Verification Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Extension was published but verification failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The extension was successfully published to the marketplace, but the verification" >> $GITHUB_STEP_SUMMARY
            echo "script could not confirm it is live with the expected version." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Possible Reasons:" >> $GITHUB_STEP_SUMMARY
            echo "- Marketplace propagation delay (can take 5-10 minutes)" >> $GITHUB_STEP_SUMMARY
            echo "- Marketplace API temporarily unavailable" >> $GITHUB_STEP_SUMMARY
            echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Recommended Actions:" >> $GITHUB_STEP_SUMMARY
            echo "1. Wait 5-10 minutes and manually verify: https://marketplace.visualstudio.com/items?itemName=$EXTENSION_ID" >> $GITHUB_STEP_SUMMARY
            echo "2. Check marketplace status: https://marketplace.visualstudio.com/" >> $GITHUB_STEP_SUMMARY
            echo "3. If extension is not visible after 15 minutes, contact marketplace support" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** This is a warning, not a failure. The publish command succeeded." >> $GITHUB_STEP_SUMMARY
            
            # Don't fail the workflow, just warn
            exit 0
          fi
      
      - name: Post success comment on release
        if: steps.publish.outputs.publish-success == 'true' && steps.verify.outputs.verify-success == 'true'
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          RELEASE_ID="${{ github.event.release.id }}"
          MARKETPLACE_URL="https://marketplace.visualstudio.com/items?itemName=pragmatic-rhino.pragmatic-rhino-suit"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          FILE_SIZE="${{ steps.verify-artifact.outputs.file-size }}"
          
          echo "📝 Posting success comment to release..."
          
          # Post comment with deployment information
          node scripts/post-release-comment.js \
            "$RELEASE_ID" \
            "$VERSION" \
            "$MARKETPLACE_URL" \
            --file-size "$FILE_SIZE" \
            --workflow-url "$WORKFLOW_URL"
          
          echo "✅ Success comment posted to release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      
      - name: Collect deployment metrics
        id: metrics
        if: steps.publish.outputs.publish-success == 'true' && steps.verify.outputs.verify-success == 'true'
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          FILE_SIZE_MB=$(echo "scale=2; ${{ steps.verify-artifact.outputs.file-size }} / 1024 / 1024" | bc)
          WORKFLOW_START="${{ github.event.repository.pushed_at }}"
          WORKFLOW_END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "📊 Collecting deployment metrics..."
          
          # Calculate deployment duration
          START_TIMESTAMP=$(date -d "$WORKFLOW_START" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$WORKFLOW_START" +%s)
          END_TIMESTAMP=$(date -d "$WORKFLOW_END" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$WORKFLOW_END" +%s)
          DURATION_SECONDS=$((END_TIMESTAMP - START_TIMESTAMP))
          DURATION_MINUTES=$((DURATION_SECONDS / 60))
          DURATION_REMAINING=$((DURATION_SECONDS % 60))
          
          echo "deployment-duration=${DURATION_MINUTES}m ${DURATION_REMAINING}s" >> $GITHUB_OUTPUT
          echo "deployment-duration-seconds=$DURATION_SECONDS" >> $GITHUB_OUTPUT
          echo "package-size-mb=$FILE_SIZE_MB" >> $GITHUB_OUTPUT
          
          echo "✅ Metrics collected:"
          echo "  - Duration: ${DURATION_MINUTES}m ${DURATION_REMAINING}s"
          echo "  - Package Size: ${FILE_SIZE_MB} MB"
      
      - name: Send success notification
        if: steps.publish.outputs.publish-success == 'true' && steps.verify.outputs.verify-success == 'true'
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          MARKETPLACE_URL="https://marketplace.visualstudio.com/items?itemName=pragmatic-rhino.pragmatic-rhino-suit"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          DEPLOYMENT_DURATION="${{ steps.metrics.outputs.deployment-duration }}"
          PACKAGE_SIZE="${{ steps.metrics.outputs.package-size-mb }}"
          
          echo "📢 Sending deployment success notification..."
          
          # Build detailed message
          DETAILS="Version: $VERSION | Package Size: ${PACKAGE_SIZE} MB | Duration: $DEPLOYMENT_DURATION | Status: Verified on marketplace"
          
          # Send notification using helper script
          node scripts/send-notification.js \
            --type deploy \
            --status success \
            --message "🚀 Extension v$VERSION deployed successfully to VS Code Marketplace" \
            --details "$DETAILS" \
            --version "$VERSION" \
            --marketplace "$MARKETPLACE_URL" \
            --url "$WORKFLOW_URL" \
            --channel github
          
          echo ""
          echo "✅ Deployment Successful!"
          echo ""
          echo "📦 Extension Details:"
          echo "  - Version: $VERSION"
          echo "  - Package Size: ${PACKAGE_SIZE} MB"
          echo ""
          echo "🔗 Links:"
          echo "  - Marketplace: $MARKETPLACE_URL"
          echo "  - Release: $RELEASE_URL"
          echo "  - Workflow: $WORKFLOW_URL"
          echo ""
          echo "⏱️ Deployment Metrics:"
          echo "  - Duration: $DEPLOYMENT_DURATION"
          echo "  - Status: ✅ Verified on marketplace"
          echo ""
          echo "The extension has been successfully deployed and verified on the VS Code Marketplace."
          echo ""
          echo "📝 Next steps:"
          echo "  1. Test installation: code --install-extension pragmatic-rhino.pragmatic-rhino-suit"
          echo "  2. Monitor marketplace metrics and user feedback"
          echo "  3. Check for any issues reported by users"
          echo "  4. Review deployment metrics for optimization opportunities"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      
      - name: Send failure notification
        if: failure()
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          
          echo "📢 Sending deployment failure notification..."
          echo ""
          echo "❌ Deployment Failed!"
          echo "Version: $VERSION"
          echo "Release: $RELEASE_URL"
          echo "Workflow: $WORKFLOW_URL"
          echo ""
          echo "The deployment to VS Code Marketplace has failed."
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Check the workflow logs for error details: $WORKFLOW_URL"
          echo "2. Verify VSCE_PAT token is valid and has correct permissions"
          echo "3. Check marketplace status: https://marketplace.visualstudio.com/"
          echo "4. Consider using the rollback workflow if needed"
          echo ""
          echo "For detailed error information, review the failed steps above."
      
      - name: Generate deployment summary
        if: always()
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          MARKETPLACE_URL="https://marketplace.visualstudio.com/items?itemName=pragmatic-rhino.pragmatic-rhino-suit"
          
          echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.publish.outputs.publish-success }}" == "true" ]; then
            if [ "${{ steps.verify.outputs.verify-success }}" == "true" ]; then
              echo "✅ **Status:** Successfully deployed and verified on VS Code Marketplace" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ **Status:** Deployed to VS Code Marketplace (verification pending)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 📦 Extension Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Release:** [${{ github.event.release.name }}](${{ github.event.release.html_url }})" >> $GITHUB_STEP_SUMMARY
            echo "- **Marketplace:** [$MARKETPLACE_URL]($MARKETPLACE_URL)" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.verify.outputs.verify-success }}" == "true" ]; then
              echo "- **Verification:** ✅ Confirmed live on marketplace" >> $GITHUB_STEP_SUMMARY
              echo "- **Release Comment:** ✅ Success comment posted" >> $GITHUB_STEP_SUMMARY
              echo "- **Notification:** ✅ Success notification sent" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Verification:** ⚠️ Could not confirm (may need manual check)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ⏱️ Deployment Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.metrics.outputs.deployment-duration }}" ]; then
              echo "- **Deployment Duration:** ${{ steps.metrics.outputs.deployment-duration }} (${{ steps.metrics.outputs.deployment-duration-seconds }}s)" >> $GITHUB_STEP_SUMMARY
              DURATION_SECONDS=${{ steps.metrics.outputs.deployment-duration-seconds }}
              if [ $DURATION_SECONDS -le 600 ]; then
                echo "- **Performance:** ✅ Within 10-minute target" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **Performance:** ⚠️ Exceeds 10-minute target" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- **Deployment Duration:** Completed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- **VSIX Size:** $(echo "scale=2; ${{ steps.verify-artifact.outputs.file-size }} / 1024 / 1024" | bc) MB" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 📝 Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.verify.outputs.verify-success }}" == "true" ]; then
              echo "1. ✅ Extension is confirmed live on the marketplace" >> $GITHUB_STEP_SUMMARY
              echo "2. ✅ Success comment posted to release" >> $GITHUB_STEP_SUMMARY
              echo "3. Test installation: \`code --install-extension pragmatic-rhino.pragmatic-rhino-suit\`" >> $GITHUB_STEP_SUMMARY
              echo "4. Monitor marketplace metrics and user feedback" >> $GITHUB_STEP_SUMMARY
            else
              echo "1. ⚠️ Manually verify the extension is live: [$MARKETPLACE_URL]($MARKETPLACE_URL)" >> $GITHUB_STEP_SUMMARY
              echo "2. Wait 5-10 minutes if not yet visible (marketplace propagation delay)" >> $GITHUB_STEP_SUMMARY
              echo "3. Test installation: \`code --install-extension pragmatic-rhino.pragmatic-rhino-suit\`" >> $GITHUB_STEP_SUMMARY
              echo "4. Monitor marketplace metrics and user feedback" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ **Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Notification:** ✅ Failure notification sent" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See error details above for troubleshooting steps." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** [${{ github.event.release.tag_name }}](${{ github.event.release.html_url }})" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY

